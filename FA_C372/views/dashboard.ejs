<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EduSphere | Student Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="/styles/style.css" />
    <style>
      .student-dashboard-v2 {
        background: #f2f4fa;
      }

      .student-shell {
        padding-top: 2.25rem;
        padding-bottom: 4rem;
      }

      .student-heading {
        border-bottom: 1px solid #e5e8f3;
        padding-bottom: 1.25rem;
        margin-bottom: 1rem;
      }

      .student-heading h1 {
        font-size: clamp(2rem, 4vw, 3rem);
        margin-bottom: 0.6rem;
      }

      .mini-wallet {
        margin-top: 1.25rem;
        max-width: 320px;
        background: #ffffff;
        border: 1px solid #e6e9f5;
        border-radius: 16px;
        padding: 1rem 1.15rem;
      }

      .mini-wallet .label {
        font-size: 0.72rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: #8a8fa4;
        font-weight: 700;
      }

      .tabs-strip {
        margin-top: 1rem;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.75rem;
        flex-wrap: wrap;
      }

      .tabs-strip .nav {
        background: #ffffff;
        border: 1px solid #e6e9f5;
        border-radius: 999px;
        padding: 0.25rem;
      }

      .tabs-strip .nav-link {
        border-radius: 999px;
        color: #5f6478;
        font-weight: 600;
        padding: 0.4rem 0.9rem;
      }

      .tabs-strip .nav-link.active {
        background: #eeebff;
        color: #5d4ae5;
      }

      .panel-soft {
        background: #ffffff;
        border: 1px solid #e6e9f5;
        border-radius: 16px;
        box-shadow: 0 14px 30px rgba(28, 35, 74, 0.08);
      }

      .panel-soft .panel-title {
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.07em;
        color: #8a8fa4;
        font-weight: 700;
        margin-bottom: 0.75rem;
      }

      .student-course-table th {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: #868ca1;
      }

      .student-course-table td {
        vertical-align: middle;
      }

      .student-course-table .progress {
        height: 6px;
        background: #eceff8;
      }

      .student-course-table .progress-bar {
        background: linear-gradient(90deg, #7566f6, #ba74e6);
      }

      .profile-card {
        padding: 1rem;
      }

      .profile-top {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
        margin-bottom: 0.75rem;
        text-align: center;
      }

      .profile-actions {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.5rem;
      }

      .profile-actions form {
        margin: 0;
      }

      .topup-card {
        padding: 1rem;
      }

      .topup-card .form-control,
      .topup-card .form-select {
        border-radius: 10px;
        background: #f7f8fd;
        border-color: #dee3f2;
      }

      .topup-brands {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0.5rem;
        margin-top: 0.75rem;
      }

      .topup-brands span {
        border: 1px solid #d7dced;
        border-radius: 10px;
        padding: 0.4rem 0.35rem;
        text-align: center;
        font-size: 0.8rem;
        font-weight: 700;
        color: #5b6076;
        background: #ffffff;
      }

      .tx-table th {
        font-size: 0.76rem;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        color: #858ca2;
      }

      @media (max-width: 991px) {
        .student-shell {
          padding-top: 1.25rem;
        }
      }
    </style>
  </head>
  <body class="student-dashboard student-dashboard-v2">
    <%- include("partials/navbar") %>

    <main class="student-shell">
      <div class="container">
        <% if (status?.topup_success) { %>
          <div class="alert alert-success">Wallet top-up successful.</div>
        <% } %>
        <% if (status?.topup_error) { %>
          <div class="alert alert-danger">Enter a valid top-up amount.</div>
        <% } %>

        <div class="row g-4">
          <div class="col-12 col-xl-8">
            <section class="student-heading">
              <p class="eyebrow text-uppercase text-muted mb-2">Student Workspace</p>
              <h1 class="fw-bold">Learning control center</h1>
              <p class="lead text-muted mb-0">
                Courses, progress, payments, and wallet management. Everything you need before starting a new module.
              </p>

              <div class="mini-wallet panel-soft">
                <p class="label mb-1">Wallet Balance</p>
                <strong class="display-6 d-block mb-1"><%= currencySymbol %><%= Number(walletDisplayBalance || 0).toFixed(2) %></strong>
                <p class="text-muted small mb-0">Estimated USD <%= Number(walletBalance || 0).toFixed(2) %></p>
              </div>
            </section>

            <section id="student-courses" class="panel-soft p-3 p-md-4 mb-4">
              <div class="tabs-strip">
                <ul class="nav" role="tablist" aria-label="Student Sections">
                  <li class="nav-item"><a class="nav-link active" href="#student-courses">Courses</a></li>
                  <li class="nav-item"><a class="nav-link" href="#student-courses">Progress</a></li>
                  <li class="nav-item"><a class="nav-link" href="#student-payments">Payments</a></li>
                </ul>
                <a class="text-muted small text-decoration-none" href="/courses">View all courses</a>
              </div>

              <h2 class="panel-title">My Courses</h2>
              <% if (!enrollments || enrollments.length === 0) { %>
                <p class="text-muted small mb-0">You have no course enrollments yet.</p>
              <% } else { %>
                <div class="table-responsive">
                  <table class="table table-borderless align-middle mb-0 student-course-table">
                    <thead>
                      <tr>
                        <th>Course</th>
                        <th>Progress</th>
                        <th>Status</th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody>
                      <% enrollments.forEach(function(item) { %>
                        <% const progress = Number(item.progress || 0); %>
                        <tr>
                          <td>
                            <strong><%= item.course_name %></strong>
                            <p class="text-muted small mb-0"><%= item.category || "General" %></p>
                          </td>
                          <td style="min-width: 230px;">
                            <div class="progress mb-1">
                              <div class="progress-bar" role="progressbar" style="width: <%= progress %>%" aria-valuenow="<%= progress %>" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <small class="text-muted"><%= progress %>% complete</small>
                          </td>
                          <td>
                            <span class="status-badge status-badge-primary">In progress</span>
                          </td>
                          <td class="text-end">
                            <a class="text-decoration-none fw-semibold" href="/learning/<%= item.course_id %>">Continue</a>
                          </td>
                        </tr>
                      <% }); %>
                    </tbody>
                  </table>
                </div>
              <% } %>
            </section>

            <section id="student-payments" class="panel-soft p-3 p-md-4">
              <div class="d-flex justify-content-between align-items-center mb-3 gap-2 flex-wrap">
                <h2 class="h4 mb-0">Recent transactions</h2>
                <a class="text-muted small text-decoration-none" href="/wallet">View all transactions</a>
              </div>

              <div class="table-responsive">
                <table class="table table-sm table-borderless align-middle mb-0 tx-table">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Type</th>
                      <th>Amount</th>
                      <th>Status</th>
                      <th>Date</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% if (!transactions || transactions.length === 0) { %>
                      <tr>
                        <td colspan="5" class="text-muted small">No transactions recorded.</td>
                      </tr>
                    <% } else { %>
                      <% transactions.forEach(function(tx) { %>
                        <tr>
                          <td><%= tx.id %></td>
                          <td class="text-capitalize"><%= String(tx.type || "").replace(/_/g, " ") %></td>
                          <td>$<%= Number(tx.amount || 0).toFixed(2) %></td>
                          <td>
                            <span class="status-badge <%= String(tx.status || "").toLowerCase() === "completed" ? "status-badge-success" : "status-badge-warning" %>">
                              <%= tx.status %>
                            </span>
                          </td>
                          <td><%= tx.created_at ? new Date(tx.created_at).toLocaleString() : "" %></td>
                        </tr>
                      <% }); %>
                    <% } %>
                  </tbody>
                </table>
              </div>
            </section>
          </div>

          <aside class="col-12 col-xl-4">
            <section class="panel-soft profile-card mb-4">
              <div class="profile-top">
                <div>
                  <h2 class="h3 mb-0"><%= currentUser?.name || "Student" %></h2>
                  <p class="eyebrow text-uppercase text-muted mb-0"><%= currentUser?.role || "student" %></p>
                </div>
              </div>
              <div class="profile-actions">
                <a class="btn btn-outline-secondary btn-sm" href="/dashboard/student">Dashboard</a>
                <form method="POST" action="/logout">
                  <button class="btn btn-primary btn-sm w-100" type="submit">Sign Out</button>
                </form>
              </div>
            </section>

            <section class="panel-soft topup-card">
              <h2 class="h4 mb-3">Top-up wallet</h2>
              <form method="POST" action="/wallet/topup">
                <div class="mb-3">
                  <label class="form-label small" for="amount">Amount</label>
                  <input class="form-control" id="amount" name="amount" type="number" step="0.01" min="1" required />
                </div>
                <div class="mb-3">
                  <label class="form-label small" for="method">Payment method</label>
                  <select class="form-select" id="method" name="payment_method">
                    <option value="wallet">Wallet</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label small" for="topup_currency">Currency</label>
                  <select class="form-select" id="topup_currency" name="currency">
                    <% (supportedCurrencies || []).forEach(function(code) { %>
                      <option value="<%= code %>" <%= code === selectedCurrency ? "selected" : "" %>><%= code %></option>
                    <% }); %>
                  </select>
                </div>
                <button class="btn btn-gradient w-100" type="submit">Top up</button>
              </form>
              <p class="text-muted small mt-3 mb-0">
                Top up your wallet with the entered amount. For PayPal, Stripe, and NETS use the <a href="/wallet">Wallet page</a>.
              </p>
              <div class="topup-brands">
                <span>VISA</span>
                <span>MC</span>
                <span>PayPal</span>
              </div>
            </section>
          </aside>
        </div>
      </div>
    </main>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
