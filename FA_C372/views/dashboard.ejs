<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EduSphere | Student Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="/styles/style.css" />
    <style>
      .student-dashboard-v2 {
        background: #f2f4fa;
      }

      .student-shell {
        padding-top: 2.25rem;
        padding-bottom: 4rem;
      }

      .student-heading {
        border-bottom: 1px solid #e5e8f3;
        padding-bottom: 1.25rem;
        margin-bottom: 1rem;
      }

      .student-heading h1 {
        font-size: clamp(2rem, 4vw, 3rem);
        margin-bottom: 0.6rem;
      }

      .mini-wallet {
        margin-top: 1.25rem;
        max-width: 340px;
        background: linear-gradient(145deg, #ffffff 0%, #f8f9ff 100%);
        border: 1px solid #dfe3f7;
        border-radius: 18px;
        padding: 1rem 1.1rem;
        box-shadow: 0 14px 28px rgba(34, 43, 89, 0.08);
      }

      .mini-wallet-top {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 0.4rem;
      }

      .mini-wallet .label {
        font-size: 0.72rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: #8a8fa4;
        font-weight: 700;
      }

      .mini-wallet-chip {
        font-size: 0.68rem;
        font-weight: 700;
        letter-spacing: 0.03em;
        color: #4338ca;
        background: #e8eaff;
        border: 1px solid #c7d2fe;
        border-radius: 999px;
        padding: 0.15rem 0.55rem;
      }

      .mini-wallet-amount {
        font-size: 2rem;
        font-weight: 800;
        color: #1f2937;
        line-height: 1.05;
        margin-bottom: 0.45rem;
      }

      .mini-wallet-usd {
        font-size: 0.78rem;
        color: #6b7280;
      }

      .mini-wallet-usd span {
        font-weight: 700;
        color: #374151;
      }

      .tabs-strip {
        margin-top: 1rem;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.75rem;
        flex-wrap: wrap;
      }

      .tabs-strip .nav {
        background: #ffffff;
        border: 1px solid #e6e9f5;
        border-radius: 999px;
        padding: 0.25rem;
      }

      .tabs-strip .nav-link {
        border-radius: 999px;
        color: #5f6478;
        font-weight: 600;
        padding: 0.4rem 0.9rem;
      }

      .tabs-strip .nav-link.active {
        background: #eeebff;
        color: #5d4ae5;
      }

      .panel-soft {
        background: #ffffff;
        border: 1px solid #e6e9f5;
        border-radius: 16px;
        box-shadow: 0 14px 30px rgba(28, 35, 74, 0.08);
      }

      .panel-soft .panel-title {
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.07em;
        color: #8a8fa4;
        font-weight: 700;
        margin-bottom: 0.75rem;
      }

      .student-course-table th {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: #868ca1;
      }

      .student-course-table td {
        vertical-align: middle;
      }

      .student-course-table .progress {
        height: 6px;
        background: #eceff8;
      }

      .student-course-table .progress-bar {
        background: linear-gradient(90deg, #7566f6, #ba74e6);
      }

      .profile-card {
        padding: 1rem;
      }

      .profile-top {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
        margin-bottom: 0.75rem;
        text-align: center;
      }

      .profile-actions {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.5rem;
      }

      .profile-actions form {
        margin: 0;
      }

      .topup-card {
        padding: 1rem;
      }

      .topup-card .form-control,
      .topup-card .form-select {
        border-radius: 10px;
        background: #f7f8fd;
        border-color: #dee3f2;
      }

      .topup-brands {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0.5rem;
        margin-top: 0.75rem;
      }

      .topup-brands span {
        border: 1px solid #d7dced;
        border-radius: 10px;
        padding: 0.4rem 0.35rem;
        text-align: center;
        font-size: 0.8rem;
        font-weight: 700;
        color: #5b6076;
        background: #ffffff;
      }

      .tx-table th {
        font-size: 0.76rem;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        color: #858ca2;
      }

      .refund-table th {
        font-size: 0.74rem;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        color: #858ca2;
      }

      .refund-table td {
        font-size: 0.81rem;
        color: #4b5563;
      }

      .purchase-history-table th {
        font-size: 0.73rem;
        text-transform: uppercase;
        letter-spacing: 0.06em;
      }

      .purchase-history-table td {
        font-size: 0.79rem;
        color: #4b5563;
      }

      .purchase-history-table .purchase-id {
        min-width: 74px;
      }

      .purchase-history-table .purchase-id strong {
        font-size: 0.78rem;
      }

      .purchase-history-table .purchase-id small {
        font-size: 0.68rem;
      }

      .purchase-history-table .purchase-date {
        white-space: normal;
        font-size: 0.74rem;
      }

      .purchase-history-table .purchase-actions {
        gap: 0.3rem;
      }

      .purchase-history-table .purchase-actions .btn {
        min-width: 0;
        padding: 0.22rem 0.52rem;
        font-size: 0.68rem;
      }

      .tx-table td {
        font-size: 0.82rem;
        color: #4b5563;
      }

      .tx-table td:first-child {
        font-size: 0.78rem;
        color: #6b7280;
      }

      .tx-table .status-badge {
        font-size: 0.68rem;
        padding: 0.1rem 0.65rem;
      }

      @media (max-width: 991px) {
        .student-shell {
          padding-top: 1.25rem;
        }
      }
    </style>
  </head>
  <body class="student-dashboard student-dashboard-v2">
    <%- include("partials/navbar") %>

    <main class="student-shell">
      <div class="container">
        <% if (status?.topup_success) { %>
          <div class="alert alert-success">Wallet top-up successful.</div>
        <% } %>
        <% if (status?.topup_error) { %>
          <div class="alert alert-danger">Enter a valid top-up amount.</div>
        <% } %>

        <div class="row g-4">
          <div class="col-12 col-xl-8">
            <section class="student-heading">
              <p class="eyebrow text-uppercase text-muted mb-2">Student Workspace</p>
              <h1 class="fw-bold">Learning control center</h1>
              <p class="lead text-muted mb-0">
                Courses, progress, payments, and wallet management. Everything you need before starting a new module.
              </p>

              <div class="mini-wallet panel-soft">
                <div class="mini-wallet-top">
                  <p class="label mb-0">Wallet Balance</p>
                  <span class="mini-wallet-chip">Live</span>
                </div>
                <strong class="mini-wallet-amount d-block"><%= currencySymbol %><%= Number(walletDisplayBalance || 0).toFixed(2) %></strong>
                <p class="mini-wallet-usd mb-0">Estimated USD <span><%= Number(walletBalance || 0).toFixed(2) %></span></p>
              </div>
            </section>

            <section id="student-progress" class="panel-soft p-3 p-md-4 mb-4">
              <div class="d-flex justify-content-between align-items-center mb-3 gap-2 flex-wrap">
                <h2 class="h4 mb-0">Progress overview</h2>
                <% const avgProgress = enrollments && enrollments.length > 0
                  ? Math.round(enrollments.reduce(function(sum, item) { return sum + Number(item.progress || 0); }, 0) / enrollments.length)
                  : 0; %>
                <span class="text-muted small">Average progress: <strong><%= avgProgress %>%</strong></span>
              </div>

              <% if (!enrollments || enrollments.length === 0) { %>
                <p class="text-muted small mb-0">Progress will appear once you enroll in a course.</p>
              <% } else { %>
                <div class="table-responsive">
                  <table class="table table-borderless align-middle mb-0 student-course-table">
                    <thead>
                      <tr>
                        <th>Course</th>
                        <th>Progress</th>
                        <th>Last activity</th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody>
                      <% enrollments.forEach(function(item) { %>
                        <% const progress = Number(item.progress || 0); %>
                        <tr>
                          <td>
                            <strong><%= item.course_name %></strong>
                            <p class="text-muted small mb-0"><%= item.category || "General" %></p>
                          </td>
                          <td style="min-width: 230px;">
                            <div class="progress mb-1">
                              <div class="progress-bar" role="progressbar" style="width: <%= progress %>%" aria-valuenow="<%= progress %>" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <small class="text-muted"><%= progress %>% complete</small>
                          </td>
                          <td class="text-muted small">
                            <%= item.updated_at ? new Date(item.updated_at).toLocaleString() : "â€”" %>
                          </td>
                          <td class="text-end">
                            <a class="text-decoration-none fw-semibold" href="/learning/<%= item.course_id %>">Continue</a>
                          </td>
                        </tr>
                      <% }); %>
                    </tbody>
                  </table>
                </div>
              <% } %>
            </section>

            <section class="panel-soft p-3 p-md-4 mb-4">
              <div class="d-flex justify-content-between align-items-center mb-3 gap-2 flex-wrap">
                <h2 class="h4 mb-0">Lecturer announcements</h2>
                <a class="text-muted small text-decoration-none" href="/learning">View my learning</a>
              </div>
              <% if (!announcements || announcements.length === 0) { %>
                <p class="text-muted small mb-0">No announcements from your lecturers yet.</p>
              <% } else { %>
                <ul class="list-group list-group-flush">
                  <% announcements.forEach(function(note) { %>
                    <li class="list-group-item px-0 py-2">
                      <div class="d-flex justify-content-between align-items-center">
                        <strong><%= note.title %></strong>
                        <span class="text-muted small"><%= note.created_at ? new Date(note.created_at).toLocaleDateString() : "" %></span>
                      </div>
                      <p class="text-muted small mb-1"><%= note.course_name %></p>
                      <p class="mb-0"><%= note.message || "No message provided." %></p>
                    </li>
                  <% }); %>
                </ul>
              <% } %>
            </section>

            <section class="panel-soft p-3 p-md-4 mb-4">
              <div class="d-flex justify-content-between align-items-center mb-3 gap-2 flex-wrap">
                <h2 class="h4 mb-0">Purchase history</h2>
                <a class="text-muted small text-decoration-none" href="/orders">Open full history</a>
              </div>
              <% if (!orders || !orders.length) { %>
                <div class="empty-state">
                  <p class="mb-2">No purchases yet.</p>
                  <a class="btn btn-outline btn-sm" href="/courses">Browse courses</a>
                </div>
              <% } else { %>
                <div class="table-responsive">
                  <table class="table align-middle mb-0 purchase-table purchase-history-table">
                    <thead>
                      <tr>
                        <th>Invoice</th>
                        <th>Total</th>
                        <th>Refunded</th>
                        <th>Payment</th>
                        <th>Status</th>
                        <th>Date</th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody>
                      <% orders.slice(0, 6).forEach(function(order) { %>
                        <tr>
                          <td class="purchase-id">
                            <strong>INV-<%= order.id %></strong>
                            <small>Order #<%= order.id %></small>
                          </td>
                          <td class="purchase-total">$<%= Number(order.total_amount || 0).toFixed(2) %></td>
                          <td>
                            <% if (Number(order.refunded_amount || 0) > 0) { %>
                              <span class="purchase-refund">$<%= Number(order.refunded_amount || 0).toFixed(2) %></span>
                            <% } else { %>
                              <span class="purchase-refund is-none">$0.00</span>
                            <% } %>
                          </td>
                          <td class="text-capitalize">
                            <span class="status-badge <%= order.payment_status === 'paid' ? 'status-badge-success' : 'status-badge-warning' %>">
                              <%= order.payment_status %>
                            </span>
                          </td>
                          <td class="text-capitalize">
                            <span class="status-badge <%= order.order_status === 'completed' ? 'status-badge-success' : 'status-badge-neutral' %>">
                              <%= order.order_status %>
                            </span>
                          </td>
                          <td class="purchase-date">
                            <%= order.created_at ? new Date(order.created_at).toLocaleString("en-US", { year: "numeric", month: "short", day: "2-digit", hour: "2-digit", minute: "2-digit" }) : "-" %>
                          </td>
                          <td>
                            <div class="purchase-actions">
                              <a class="btn btn-sm btn-outline-primary" href="/orders/<%= order.id %>">View</a>
                              <a class="btn btn-sm btn-outline-secondary" href="/orders/<%= order.id %>?download=invoice">PDF</a>
                            </div>
                          </td>
                        </tr>
                      <% }); %>
                    </tbody>
                  </table>
                </div>
              <% } %>
            </section>

            <section class="panel-soft p-3 p-md-4 mb-4">
              <div class="d-flex justify-content-between align-items-center mb-3 gap-2 flex-wrap">
                <h2 class="h4 mb-0">Refund requests</h2>
                <a class="text-muted small text-decoration-none" href="/refunds">Open all refunds</a>
              </div>
              <% if (!refunds || !refunds.length) { %>
                <div class="empty-state">No refund requests yet.</div>
              <% } else { %>
                <div class="table-responsive">
                  <table class="table align-middle mb-0 refund-table">
                    <thead>
                      <tr>
                        <th>Request #</th>
                        <th>Order #</th>
                        <th>Amount</th>
                        <th>Method</th>
                        <th>Status</th>
                        <th>Date</th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody>
                      <% refunds.slice(0, 6).forEach(function(item) { %>
                        <tr>
                          <td><%= item.id %></td>
                          <td><%= item.order_id %></td>
                          <td>$<%= Number(item.requested_amount || 0).toFixed(2) %></td>
                          <td class="text-capitalize"><%= item.payment_method || "-" %></td>
                          <td class="text-capitalize"><%= item.status %></td>
                          <td><%= item.created_at ? new Date(item.created_at).toLocaleString() : "" %></td>
                          <td class="text-end"><a class="btn btn-sm btn-outline-primary" href="/refunds/<%= item.id %>">View</a></td>
                        </tr>
                      <% }); %>
                    </tbody>
                  </table>
                </div>
              <% } %>
            </section>

            <section id="student-payments" class="panel-soft p-3 p-md-4">
              <div class="d-flex justify-content-between align-items-center mb-3 gap-2 flex-wrap">
                <h2 class="h4 mb-0">Recent transactions</h2>
                <a class="text-muted small text-decoration-none" href="/wallet">View all transactions</a>
              </div>

              <div class="table-responsive">
                <table class="table table-sm table-borderless align-middle mb-0 tx-table">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Type</th>
                      <th>Amount</th>
                      <th>Status</th>
                      <th>Date</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% if (!transactions || transactions.length === 0) { %>
                      <tr>
                        <td colspan="5" class="text-muted small">No transactions recorded.</td>
                      </tr>
                    <% } else { %>
                      <% transactions.forEach(function(tx) { %>
                        <tr>
                          <td><%= tx.id %></td>
                          <td class="text-capitalize"><%= String(tx.type || "").replace(/_/g, " ") %></td>
                          <td>$<%= Number(tx.amount || 0).toFixed(2) %></td>
                          <td>
                            <span class="status-badge <%= String(tx.status || "").toLowerCase() === "completed" ? "status-badge-success" : "status-badge-warning" %>">
                              <%= tx.status %>
                            </span>
                          </td>
                          <td><%= tx.created_at ? new Date(tx.created_at).toLocaleString() : "" %></td>
                        </tr>
                      <% }); %>
                    <% } %>
                  </tbody>
                </table>
              </div>
            </section>
          </div>

          <aside class="col-12 col-xl-4">
            <section class="panel-soft profile-card mb-4">
              <div class="profile-top">
                <div>
                  <h2 class="h3 mb-0"><%= currentUser?.name || "Student" %></h2>
                  <p class="eyebrow text-uppercase text-muted mb-0"><%= currentUser?.role || "student" %></p>
                </div>
              </div>
              <div class="profile-actions">
                <a class="btn btn-outline-secondary btn-sm" href="/dashboard/student">Dashboard</a>
                <form method="POST" action="/logout">
                  <button class="btn btn-primary btn-sm w-100" type="submit">Sign Out</button>
                </form>
              </div>
            </section>

            <section class="panel-soft topup-card">
              <h2 class="h4 mb-3">Top-up wallet</h2>
              <form method="POST" action="/wallet/topup">
                <div class="mb-3">
                  <label class="form-label small" for="amount">Amount</label>
                  <input class="form-control" id="amount" name="amount" type="number" step="0.01" min="1" required />
                </div>
                <div class="mb-3">
                  <label class="form-label small" for="method">Payment method</label>
                  <select class="form-select" id="method" name="payment_method">
                    <option value="wallet">Wallet</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label small" for="topup_currency">Currency</label>
                  <select class="form-select" id="topup_currency" name="currency">
                    <% (supportedCurrencies || []).forEach(function(code) { %>
                      <option value="<%= code %>" <%= code === selectedCurrency ? "selected" : "" %>><%= code %></option>
                    <% }); %>
                  </select>
                </div>
                <button class="btn btn-gradient w-100" type="submit">Top up</button>
              </form>
              <p class="text-muted small mt-3 mb-0">
                Top up your wallet with the entered amount. For PayPal, Stripe, and NETS use the <a href="/wallet">Wallet page</a>.
              </p>
              <div class="topup-brands">
                <span>VISA</span>
                <span>MC</span>
                <span>PayPal</span>
              </div>
            </section>
          </aside>
        </div>
      </div>
    </main>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
    <script>
      (function () {
        const links = Array.from(document.querySelectorAll(".tabs-strip .nav-link"));
        if (!links.length) return;

        function setActive(hash) {
          links.forEach((link) => {
            const target = link.getAttribute("href");
            link.classList.toggle("active", target === hash);
          });
        }

        function scrollToHash(hash) {
          const target = document.querySelector(hash);
          if (!target) return;
          target.scrollIntoView({ behavior: "smooth", block: "start" });
        }

        links.forEach((link) => {
          link.addEventListener("click", (event) => {
            const hash = link.getAttribute("href");
            if (!hash || !hash.startsWith("#")) return;
            event.preventDefault();
            history.replaceState(null, "", hash);
            setActive(hash);
            scrollToHash(hash);
          });
        });

        const initialHash = window.location.hash || "#student-progress";
        setActive(initialHash);
      })();
    </script>
      <%- include("partials/footer") %>
  </body>
</html>
