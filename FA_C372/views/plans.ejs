<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EduSphere | Plans</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Manrope:wght@300..800&family=Space+Grotesk:wght@400..700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="/styles/style.css" />
  </head>
  <body class="plans-page">
    <%- include("partials/navbar") %>
    <main class="section plans-section">
      <div class="container">
        <header class="plans-hero mb-5 text-center">
          <span class="badge-pill mb-2">Pricing Plan</span>
          <h1 class="display-4 fw-bold">Invest in Your Future</h1>
          <p class="lead text-muted">Choose a plan that fits your learning journey.</p>
        </header>
        <% if (status?.subscription_success) { %>
          <div class="alert alert-success">
            Subscription updated successfully to <strong><%= (status.plan || "").toUpperCase() %></strong>.
          </div>
        <% } %>
        <% if (status?.subscription_error === "invalid_plan") { %>
          <div class="alert alert-danger">Selected plan is invalid. Please try again.</div>
        <% } %>
        <% if (currentSubscription) { %>
          <div class="alert alert-info">
            Current plan: <strong><%= currentSubscription.plan_name %></strong>
            (<%= currentSubscription.status %>)
          </div>
        <% } %>

        <div class="plans-grid">
          <% plans.forEach(function(plan, index) { %>
            <article class="plan-card<%= index === 1 ? ' plan-starred' : '' %>">
              <h2 class="plan-name"><%= plan.name %></h2>
              <p class="plan-description text-muted mb-3"><%= plan.description %></p>
              <div class="plan-price mb-4">
                <% if (plan.price === 0) { %>
                  $0 <span class="plan-duration">/ month</span>
                <% } else if (plan.price === "Custom") { %>
                  Custom
                <% } else { %>
                  $<%= plan.price %> <span class="plan-duration">/ month</span>
                <% } %>
              </div>
              <ul class="plan-feature-list">
                <% plan.perks.forEach(function(perk) { %>
                  <li><span class="perk-dot"></span><%= perk %></li>
                <% }); %>
              </ul>
              <% const isLoggedStudent = currentUser && String(currentUser.role).toLowerCase() === "student"; %>
              <% const isActivePlan = currentSubscription && currentSubscription.plan_code === plan.code; %>
              <% if (isLoggedStudent) { %>
                <form method="POST" action="/plans/subscribe" class="mt-auto">
                  <input type="hidden" name="plan_code" value="<%= plan.code %>" />
                  <button
                    class="btn plan-btn w-100<%= index === 1 ? ' btn-primary' : ' btn-outline' %>"
                    type="submit"
                    <%= isActivePlan ? "disabled" : "" %>
                  >
                    <%= isActivePlan ? "Current Plan" : plan.cta %>
                  </button>
                </form>
              <% } else if (currentUser) { %>
                <button class="btn plan-btn mt-auto<%= index === 1 ? ' btn-primary' : ' btn-outline' %>" disabled>
                  Student plan only
                </button>
              <% } else { %>
                <a class="btn plan-btn mt-auto<%= index === 1 ? ' btn-primary' : ' btn-outline' %>" href="/login">
                  Log in to subscribe
                </a>
              <% } %>
            </article>
          <% }); %>
        </div>
      </div>
    </main>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
