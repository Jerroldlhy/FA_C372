<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EduSphere | Cart</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="/styles/style.css" />
  </head>
  <body class="course-page">
    <%- include("partials/navbar") %>
    <main class="section">
      <div class="container">
        <div class="course-hero mb-4">
          <div>
            <p class="eyebrow text-uppercase text-muted mb-2">Checkout</p>
            <h1 class="display-6 fw-bold mb-1">Your Cart</h1>
            <p class="text-muted mb-0">Review selected courses before payment.</p>
          </div>
          <div class="course-hero-card">
            <p class="text-muted small mb-1">Items</p>
            <strong class="display-6"><%= items.length %></strong>
            <p class="text-muted small mb-0">Total: <%= currencySymbol %><%= Number(convertedTotal || 0).toFixed(2) %> <%= currency %></p>
            <% if (currency !== baseCurrency) { %>
              <p class="text-muted small mb-0">Base <%= baseCurrency %>: <%= baseCurrencySymbol %><%= Number(total || 0).toFixed(2) %></p>
            <% } %>
          </div>
        </div>

        <% if (status?.removed) { %>
          <div class="alert alert-info">Item removed from cart.</div>
        <% } %>
        <% if (status?.checkout_error === "wallet_balance") { %>
          <div class="alert alert-danger">Insufficient wallet balance for checkout.</div>
        <% } %>
        <% if (status?.checkout_error === "empty_cart") { %>
          <div class="alert alert-warning">Your cart is empty.</div>
        <% } %>
        <% if (status?.checkout_error === "out_of_stock") { %>
          <div class="alert alert-danger">One or more courses are out of stock.</div>
        <% } %>
        <% if (status?.checkout_error === "already_enrolled") { %>
          <div class="alert alert-info">All cart items are already in your enrollments.</div>
        <% } %>
        <% if (status?.checkout_error === "payment_required") { %>
          <div class="alert alert-warning">Complete your external payment first, then place order.</div>
        <% } %>
        <% if (status?.checkout_error === "invalid_payment_method") { %>
          <div class="alert alert-danger">Invalid payment method selected.</div>
        <% } %>
        <% if (status?.payment_ready) { %>
          <div class="alert alert-success text-capitalize"><%= status.payment_ready %> payment verified. You can place the order now.</div>
        <% } %>
        <% if (status?.payment_error) { %>
          <div class="alert alert-danger text-capitalize">Payment issue: <%= status.payment_error.replace(/_/g, " ") %>.</div>
        <% } %>
        <% if (status?.currency_updated) { %>
          <div class="alert alert-success">Payment currency updated to <strong><%= currency %></strong>.</div>
        <% } %>

        <div class="dashboard-panel">
          <% if (!items.length) { %>
            <div class="empty-state">
              <p class="mb-2">No items in cart yet.</p>
              <a href="/courses" class="btn btn-outline btn-sm">Browse courses</a>
            </div>
          <% } else { %>
            <div class="table-responsive">
              <table class="table align-middle mb-4 cart-table">
                <thead>
                  <tr>
                    <th>Course</th>
                    <th>Category</th>
                    <th>Price</th>
                    <th>Enrollment</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  <% items.forEach(function(item) { %>
                    <tr>
                      <td data-label="Course">
                        <strong><%= item.course_name %></strong>
                        <div class="text-muted small">
                          <%= item.level || "General" %> - <%= item.language || "N/A" %>
                        </div>
                      </td>
                      <td data-label="Category"><%= item.category || "General" %></td>
                      <td data-label="Price">$<%= Number(item.price || 0).toFixed(2) %></td>
                      <td data-label="Enrollment">
                        <span class="text-muted small">1 seat (fixed)</span>
                      </td>
                      <td class="text-end" data-label="Actions">
                        <form method="POST" action="/cart/<%= item.course_id %>/remove">
                          <button class="btn btn-sm btn-outline-danger" type="submit">Remove</button>
                        </form>
                      </td>
                    </tr>
                  <% }); %>
                </tbody>
              </table>
            </div>

            <div class="dashboard-panel mb-3">
              <h5 class="mb-2">Payment Methods</h5>
              <p class="text-muted small mb-3">
                Choose a method below, complete payment, then place your order.
                Apple Pay / Google Pay can be supported through Stripe account settings.
              </p>
              <div class="alert alert-info small py-2 mb-3">
                <strong>Checkout flow:</strong> 1) Choose method, 2) Complete external payment (if needed), 3) Place order.
              </div>
              <form method="POST" action="/payments/currency" class="row g-2 mb-3">
                <div class="col-12 col-md-8">
                  <label class="form-label small mb-1" for="payment_currency">Payment currency</label>
                  <select class="form-select form-select-sm" id="payment_currency" name="currency">
                    <% (supportedCurrencies || []).forEach(function(code) { %>
                      <option value="<%= code %>" <%= code === currency ? "selected" : "" %>><%= code %></option>
                    <% }); %>
                  </select>
                </div>
                <div class="col-12 col-md-4 d-grid">
                  <label class="form-label small mb-1">&nbsp;</label>
                  <button class="btn btn-outline btn-sm" type="submit">Apply currency</button>
                </div>
              </form>
              <p class="text-muted small mb-3">NETS QR is always charged in SGD.</p>

              <div class="row g-2 mb-3">
                <div class="col-12 col-md-3">
                  <button class="btn btn-outline w-100" type="button" data-method="wallet" id="methodWallet">Wallet</button>
                </div>
                <div class="col-12 col-md-3">
                  <button class="btn btn-outline w-100" type="button" data-method="paypal" id="methodPaypal">PayPal</button>
                </div>
                <div class="col-12 col-md-3">
                  <button class="btn btn-outline w-100" type="button" data-method="stripe" id="methodStripe">Stripe Card</button>
                </div>
                <div class="col-12 col-md-3">
                  <button class="btn btn-outline w-100" type="button" data-method="nets" id="methodNets">NETS QR</button>
                </div>
              </div>

              <div id="actionWallet" class="payment-action">
                <p class="small text-muted mb-2">No pre-step needed. Click <strong>Place order</strong> using wallet.</p>
              </div>

              <div id="actionPaypal" class="payment-action d-none">
                <p class="small text-muted mb-2">Use the same PayPal secure button flow as Wallet top-up.</p>
                <div id="paypal-button-container" class="border rounded p-2 bg-light"></div>
                <div id="paypal-msg" class="small text-danger mt-2" style="display:none;"></div>
              </div>

              <div id="actionStripe" class="payment-action d-none">
                <button class="btn btn-outline" type="button" id="btnStripe">Go to Stripe Checkout</button>
              </div>

              <div id="actionNets" class="payment-action d-none">
                <form method="POST" action="/payments/nets/request" class="d-inline">
                  <button class="btn btn-outline" type="submit">Generate NETS QR</button>
                </form>
              </div>

              <% if (activePayment) { %>
                <p class="text-success small mt-3 mb-0">
                  Payment verified in session: <strong><%= activePayment.method %></strong>
                </p>
              <% } %>
            </div>

            <form class="row g-2" method="POST" action="/checkout" id="checkoutForm">
              <div class="col-12 col-md-4" id="checkoutMethodField">
                <label class="form-label small" for="payment_method">Payment method</label>
                <select class="form-select" id="payment_method" name="payment_method">
                  <option value="wallet">Wallet</option>
                  <option value="paypal">PayPal</option>
                  <option value="stripe">Stripe Card</option>
                  <option value="nets">NETS QR</option>
                </select>
              </div>
              <div class="col-12 col-md-4">
                <label class="form-label small">&nbsp;</label>
                <div class="form-control text-muted">Total: <%= currencySymbol %><%= Number(convertedTotal || 0).toFixed(2) %> <%= currency %></div>
              </div>
              <div class="col-12 col-md-4 d-grid">
                <label class="form-label small">&nbsp;</label>
                <button class="btn btn-gradient" id="placeOrderBtn" type="submit">Place order</button>
              </div>
            </form>
          <% } %>
        </div>
      </div>
    </main>

    <% if (paypalClientId) { %>
      <script src="https://www.paypal.com/sdk/js?client-id=<%= paypalClientId %>&currency=<%= currency %>&intent=capture"></script>
    <% } %>
    <script>
      async function postJson(url, body) {
        const res = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body || {}),
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data.error || "Request failed.");
        return data;
      }

      const btnStripe = document.getElementById("btnStripe");
      const methodSelect = document.getElementById("payment_method");
      const methodButtons = document.querySelectorAll("[data-method]");
      const checkoutMethodField = document.getElementById("checkoutMethodField");
      const checkoutForm = document.getElementById("checkoutForm");
      const placeOrderBtn = document.getElementById("placeOrderBtn");
      const paypalMsg = document.getElementById("paypal-msg");
      const activePaymentMethod = "<%= String(activePayment?.method || '').toLowerCase() %>";
      const paymentNotice = document.createElement("div");
      paymentNotice.className = "text-muted small mt-2";
      const actionSections = {
        wallet: document.getElementById("actionWallet"),
        paypal: document.getElementById("actionPaypal"),
        stripe: document.getElementById("actionStripe"),
        nets: document.getElementById("actionNets"),
      };
      let paymentInProgress = false;

      function setPaymentInProgress(active) {
        paymentInProgress = !!active;
        methodButtons.forEach((btn) => {
          btn.disabled = paymentInProgress;
        });
        if (btnStripe) btnStripe.disabled = paymentInProgress;
      }

      function showPaypalError(text) {
        if (!paypalMsg) return;
        paypalMsg.style.display = "block";
        paypalMsg.textContent = text || "Unable to process PayPal payment.";
      }

      function showAction(method) {
        Object.keys(actionSections).forEach((key) => {
          const el = actionSections[key];
          if (!el) return;
          if (key === method) el.classList.remove("d-none");
          else el.classList.add("d-none");
        });
        if (methodSelect) methodSelect.value = method;
        methodButtons.forEach((btn) => {
          const active = btn.getAttribute("data-method") === method;
          btn.classList.toggle("btn-primary", active);
          btn.classList.toggle("btn-outline", !active);
        });

        if (checkoutMethodField && !paymentNotice.isConnected) {
          checkoutMethodField.appendChild(paymentNotice);
        }
        paymentNotice.textContent =
          method === "wallet"
            ? "Wallet will be charged when you place order."
            : "Complete payment verification first, then place order.";
        const needsExternalVerification = method === "paypal" || method === "stripe" || method === "nets";
        const verifiedForMethod = activePaymentMethod && activePaymentMethod === method;
        if (placeOrderBtn) {
          placeOrderBtn.disabled = needsExternalVerification && !verifiedForMethod;
        }
        if (needsExternalVerification && !verifiedForMethod) {
          paymentNotice.textContent = "Complete " + method.toUpperCase() + " payment first, then place order.";
        }
        if (needsExternalVerification && verifiedForMethod) {
          paymentNotice.textContent = method.toUpperCase() + " payment verified. You can place order now.";
        }
      }

      methodButtons.forEach((btn) => {
        btn.addEventListener("click", () => showAction(btn.getAttribute("data-method")));
      });

      if (methodSelect) {
        methodSelect.addEventListener("change", (e) => showAction(e.target.value));
        showAction(methodSelect.value || "wallet");
      }

      if (window.paypal) {
        window.paypal.Buttons({
          onClick: function (data, actions) {
            if (paymentInProgress) {
              showPaypalError("Payment is already in progress.");
              return actions.reject();
            }
            setPaymentInProgress(true);
            if (paypalMsg) paypalMsg.style.display = "none";
            return actions.resolve();
          },
          createOrder: function () {
            return postJson("/api/paypal/create-order")
              .then(function (order) {
                if (!order || !order.id) throw new Error("Invalid PayPal order response");
                return order.id;
              })
              .catch(function (err) {
                setPaymentInProgress(false);
                showPaypalError(err && err.message ? err.message : "Unable to start PayPal payment.");
              });
          },
          onApprove: function (data) {
            return postJson("/api/paypal/capture-order", { orderId: data.orderID })
              .then(function () {
                window.location.href = "/cart?payment_ready=paypal";
              })
              .catch(function (err) {
                setPaymentInProgress(false);
                showPaypalError(err && err.message ? err.message : "Payment capture failed.");
              });
          },
          onCancel: function () {
            setPaymentInProgress(false);
            showPaypalError("Payment cancelled.");
          },
          onError: function () {
            setPaymentInProgress(false);
            showPaypalError("Unable to start PayPal payment.");
          },
        }).render("#paypal-button-container");
      }

      if (btnStripe) {
        btnStripe.addEventListener("click", async () => {
          try {
            if (paymentInProgress) return;
            setPaymentInProgress(true);
            const data = await postJson("/api/stripe/create-checkout-session");
            if (data.url) window.location.href = data.url;
          } catch (err) {
            setPaymentInProgress(false);
            alert(err.message);
          }
        });
      }

      if (checkoutForm) {
        checkoutForm.addEventListener("submit", function (event) {
          const selected = (methodSelect && methodSelect.value) || "wallet";
          const needsExternalVerification = selected === "paypal" || selected === "stripe" || selected === "nets";
          const verifiedForMethod = activePaymentMethod && activePaymentMethod === selected;
          if (needsExternalVerification && !verifiedForMethod) {
            event.preventDefault();
            alert("Please complete " + selected.toUpperCase() + " payment first.");
          }
        });
      }
    </script>
  </body>
</html>
