<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EduSphere | Courses</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Manrope:wght@300..800&family=Space+Grotesk:wght@400..700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="/styles/style.css" />
    <style>
      .courses-hero {
        border: 1px solid #e8eaf8;
        border-radius: 20px;
        padding: 1.5rem;
        background: linear-gradient(135deg, #ffffff 0%, #f2f6ff 60%, #fff5f7 100%);
      }
      .courses-filter-panel {
        border-radius: 18px;
        border: 1px solid #e8eaf8;
        background: #ffffff;
      }
      .course-list .course-card {
        border: 1px solid #e6e9f7;
        border-radius: 18px;
        box-shadow: 0 14px 24px rgba(18, 31, 76, 0.08);
      }
      .course-list .course-card:hover {
        transform: translateY(-3px);
      }
      .course-visibility-note {
        color: #55607a;
        font-size: 0.9rem;
      }
      .course-empty {
        display: none;
        border: 1px dashed #cfd8ef;
        border-radius: 14px;
        padding: 1rem;
        text-align: center;
        color: #34405d;
        background: #fafcff;
      }
    </style>
  </head>
  <body>
    <%- include("partials/navbar") %>
    <main class="section course-page">
      <div class="container">
        <div class="course-hero courses-hero mb-4">
          <div>
            <p class="eyebrow text-uppercase text-muted mb-2">Course Hub</p>
            <h1 class="display-5 fw-bold mb-2">Browse courses</h1>
            <p class="lead text-muted">
              Explore all available courses, then narrow down by topic, level,
              language, or price in one place.
            </p>
            <% if (currentUser && currentUser.role === "student") { %>
              <div class="d-flex flex-wrap gap-2 mt-3">
                <a class="btn btn-outline btn-sm" href="/cart">Go to cart</a>
                <a class="btn btn-outline btn-sm" href="/learning">My learning</a>
              </div>
            <% } %>
          </div>
        </div>

        <% if (status?.course_created) { %>
          <div class="alert alert-success">Course published.</div>
        <% } %>
        <% if (status?.course_updated) { %>
          <div class="alert alert-success">Course details updated.</div>
        <% } %>
        <% if (status?.course_deleted) { %>
          <div class="alert alert-success">Course removed from catalog.</div>
        <% } %>
        <% if (status?.course_error) { %>
          <div class="alert alert-danger">Name and price are required.</div>
        <% } %>
        <% if (status?.enrolled) { %>
          <div class="alert alert-success">Enrolled! Check "My Dashboard" for progress.</div>
        <% } %>
        <% if (status?.enroll_error === "wallet_balance") { %>
          <div class="alert alert-danger">Top up your wallet - balance is insufficient.</div>
        <% } %>
        <% if (status?.enroll_error === "already_enrolled") { %>
          <div class="alert alert-info">You are already enrolled in this course.</div>
        <% } %>
        <% if (status?.enroll_error === "course_missing") { %>
          <div class="alert alert-danger">Course not found.</div>
        <% } %>
        <% if (status?.enroll_error === "external_checkout") { %>
          <div class="alert alert-warning">
            External payments are handled in Cart checkout. Add your course to cart first.
          </div>
        <% } %>
        <% if (status?.enroll_error === "pro_required") { %>
          <div class="alert alert-info">
            This course requires a Pro subscription. Visit <a href="/plans">Plans</a> to upgrade.
          </div>
        <% } %>
        <% if (status?.review_success) { %>
          <div class="alert alert-success">Thanks for the review!</div>
        <% } %>
        <% if (status?.review_error === "not_enrolled") { %>
          <div class="alert alert-danger">Enroll first to leave a review.</div>
        <% } %>
        <% if (status?.cart_added) { %>
          <div class="alert alert-success">Course added to cart.</div>
        <% } %>
        <% if (status?.cart_error === "already_enrolled") { %>
          <div class="alert alert-info">You are already enrolled in this course.</div>
        <% } %>
        <% if (status?.cart_error === "course_missing") { %>
          <div class="alert alert-danger">Could not add item to cart.</div>
        <% } %>
        <% if (status?.cart_error === "pro_required") { %>
          <div class="alert alert-info">
            This course requires a Pro subscription. Visit <a href="/plans">Plans</a> to upgrade.
          </div>
        <% } %>

        <div class="dashboard-panel card courses-filter-panel mb-4">
          <div class="card-body">
            <form class="row g-2 align-items-end" id="courseFilterForm" autocomplete="off">
              <div class="col-12 col-md-3">
                <label class="form-label small" for="q">Search</label>
                <input class="form-control form-control-sm" id="q" name="q" value="<%= filters?.q || '' %>" placeholder="Course name or keyword" />
              </div>
              <div class="col-6 col-md-2">
                <label class="form-label small" for="categoryFilter">Category</label>
                <select class="form-select form-select-sm" id="categoryFilter" name="category">
                  <option value="">All</option>
                  <% (filterOptions?.categories || []).forEach(function(opt) { %>
                    <option value="<%= opt %>" <%= filters?.category === opt ? "selected" : "" %>><%= opt %></option>
                  <% }); %>
                </select>
              </div>
              <div class="col-6 col-md-2">
                <label class="form-label small" for="levelFilter">Level</label>
                <select class="form-select form-select-sm" id="levelFilter" name="level">
                  <option value="">All</option>
                  <% (filterOptions?.levels || []).forEach(function(opt) { %>
                    <option value="<%= opt %>" <%= filters?.level === opt ? "selected" : "" %>><%= opt %></option>
                  <% }); %>
                </select>
              </div>
              <div class="col-6 col-md-2">
                <label class="form-label small" for="languageFilter">Language</label>
                <select class="form-select form-select-sm" id="languageFilter" name="language">
                  <option value="">All</option>
                  <% (filterOptions?.languages || []).forEach(function(opt) { %>
                    <option value="<%= opt %>" <%= filters?.language === opt ? "selected" : "" %>><%= opt %></option>
                  <% }); %>
                </select>
              </div>
              <div class="col-6 col-md-1">
                <label class="form-label small" for="minPrice">Min</label>
                <input class="form-control form-control-sm" id="minPrice" name="min_price" type="number" min="0" step="0.01" value="<%= filters?.minPrice || '' %>" />
              </div>
              <div class="col-6 col-md-1">
                <label class="form-label small" for="maxPrice">Max</label>
                <input class="form-control form-control-sm" id="maxPrice" name="max_price" type="number" min="0" step="0.01" value="<%= filters?.maxPrice || '' %>" />
              </div>
              <div class="col-6 col-md-1 d-grid">
                <button class="btn btn-sm btn-primary" type="submit">Filter</button>
              </div>
              <div class="col-6 col-md-1 d-grid">
                <button class="btn btn-sm btn-outline-secondary" id="clearFilters" type="button">Clear</button>
              </div>
            </form>
            <p class="course-visibility-note mt-2 mb-0" id="courseVisibilityText"></p>
          </div>
        </div>

        <% const isStudentPage = currentUser && currentUser.role === "student"; %>
        <div class="row g-4">
          <div class="<%= isStudentPage ? 'col-12 col-lg-8' : 'col-12' %>">
            <div class="course-list" id="courseList">
              <% courses.forEach(function (course) { %>
                <% const isStudent = currentUser && currentUser.role === "student"; %>
                <% const enrolled = enrolledCourseIds.includes(course.id); %>
                <% const inCart = cartCourseIds.includes(course.id); %>
                <% const topReview = reviewsMap[course.id] && reviewsMap[course.id][0]; %>
                <% const isProCourse = String(course.subscription_model || "free").toLowerCase() === "pro"; %>
                <% const proBlocked = isStudent && isProCourse && !isProSubscriber; %>
                <article
                  class="course-card"
                  data-course-name="<%= String(course.course_name || '').toLowerCase() %>"
                  data-course-description="<%= String(course.description || '').toLowerCase() %>"
                  data-category="<%= String(course.category || 'General').toLowerCase() %>"
                  data-level="<%= String(course.level || '').toLowerCase() %>"
                  data-language="<%= String(course.language || '').toLowerCase() %>"
                  data-price="<%= Number(course.price || 0) %>"
                >
                  <div class="d-flex justify-content-between align-items-start mb-2">
                    <div>
                      <p class="text-muted small mb-1">
                        <%= course.category || "General" %>
                      </p>
                      <h3 class="mb-1"><%= course.course_name %></h3>
                      <p class="text-muted small mb-0">
                        Instructor: <%= course.instructor_name || "TBA" %>
                      </p>
                    </div>
                    <div class="text-end">
                      <strong>$<%= Number(course.price).toFixed(2) %></strong>
                      <p class="text-muted small mb-0">
                        Rating:
                        <%= Number(course.avg_rating || 0).toFixed(1) %>/5
                        (<%= course.review_count %>)
                      </p>
                      <span class="badge <%= isProCourse ? 'text-bg-dark' : 'text-bg-success' %>">
                        <%= isProCourse ? "Pro" : "Free" %>
                      </span>
                    </div>
                  </div>
                  <p class="text-muted small mb-2">
                    <%= course.description || "No description provided yet." %>
                  </p>
                  <% if (topReview && topReview.review) { %>
                    <div class="review-snippet mb-3">
                      <strong><%= topReview.student_name %></strong>
                      <span class="text-muted small mx-2">|</span>
                      <span class="text-muted small"><%= topReview.rating %>/5</span>
                      <p class="text-muted small mb-0">
                        <%= topReview.review %>
                      </p>
                    </div>
                  <% } %>

                  <% if (isStudent) { %>
                    <form
                      class="enroll-form d-flex flex-wrap align-items-center gap-2 mb-2"
                      method="POST"
                      action="/courses/<%= course.id %>/enroll"
                    >
                      <label class="text-muted small mb-0 me-2">Payment</label>
                      <select
                        class="form-select form-select-sm"
                        name="payment_method"
                        aria-label="Payment method"
                      >
                        <option value="wallet">Wallet</option>
                      </select>
                      <button
                        class="btn btn-primary btn-sm"
                        type="submit"
                        <%= enrolled || proBlocked ? "disabled" : "" %>
                      >
                        <%= enrolled ? "Enrolled" : "Enroll" %>
                      </button>
                    </form>
                    <form
                      class="d-flex align-items-center gap-2 mb-3"
                      method="POST"
                      action="/courses/<%= course.id %>/cart"
                    >
                      <button class="btn btn-outline-secondary btn-sm" type="submit" <%= inCart || proBlocked ? "disabled" : "" %>>
                        <%= inCart ? "In Cart" : "Add to cart" %>
                      </button>
                    </form>
                    <% if (proBlocked) { %>
                      <p class="text-muted small mb-3">Pro subscription required to enroll.</p>
                    <% } %>
                    <% if (enrolled) { %>
                      <p class="text-success small mb-3">You can now leave a review below.</p>
                      <form
                        class="review-form mb-3"
                        method="POST"
                        action="/courses/<%= course.id %>/review"
                      >
                        <div class="row g-2">
                          <div class="col-4">
                            <label class="form-label small">Rating (1-5)</label>
                            <input
                              class="form-control form-control-sm"
                              type="number"
                              name="rating"
                              min="1"
                              max="5"
                              value="5"
                              required
                            />
                          </div>
                          <div class="col-8">
                            <label class="form-label small">Review</label>
                            <input
                              class="form-control form-control-sm"
                              type="text"
                              name="review"
                              placeholder="Share your thoughts"
                            />
                          </div>
                          <div class="col-12 text-end">
                            <button class="btn btn-outline-primary btn-sm" type="submit">
                              Submit review
                            </button>
                          </div>
                        </div>
                      </form>
                    <% } %>
                  <% } %>

                </article>
              <% }); %>
            </div>
            <div class="course-empty mt-3" id="courseEmptyState">
              <div id="courseEmptyMessage">No courses match your current filters.</div>
              <button class="btn btn-sm btn-outline-secondary mt-2" type="button" id="emptyStateResetBtn">Reset filters</button>
            </div>
          </div>

          <% if (isStudentPage) { %>
            <div class="col-12 col-lg-4">
              <div class="dashboard-panel card mb-4">
                <div class="panel-header mb-1">
                  <h5 class="card-title mb-0">Wallet balance</h5>
                </div>
                <p class="display-6 fw-semibold mb-1">$<%= Number(walletBalance || 0).toFixed(2) %></p>
                <p class="text-muted small">Use wallet or external payment at checkout.</p>
              </div>
            </div>
          <% } %>
        </div>
      </div>
    </main>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
    <script>
      (function () {
        const form = document.getElementById("courseFilterForm");
        const clearBtn = document.getElementById("clearFilters");
        const cards = Array.from(document.querySelectorAll("#courseList .course-card"));
        const emptyState = document.getElementById("courseEmptyState");
        const emptyMsg = document.getElementById("courseEmptyMessage");
        const emptyResetBtn = document.getElementById("emptyStateResetBtn");
        const visibilityText = document.getElementById("courseVisibilityText");
        if (!form) return;
        if (!cards.length) {
          if (emptyState) emptyState.style.display = "block";
          if (emptyMsg) emptyMsg.textContent = "No courses are published yet.";
          if (emptyResetBtn) emptyResetBtn.style.display = "none";
          if (visibilityText) visibilityText.textContent = "Showing 0 of 0 courses";
          return;
        }

        const q = document.getElementById("q");
        const category = document.getElementById("categoryFilter");
        const level = document.getElementById("levelFilter");
        const language = document.getElementById("languageFilter");
        const min = document.getElementById("minPrice");
        const max = document.getElementById("maxPrice");

        const applyFilters = () => {
          const qValue = String(q.value || "").trim().toLowerCase();
          const categoryValue = String(category.value || "").trim().toLowerCase();
          const levelValue = String(level.value || "").trim().toLowerCase();
          const languageValue = String(language.value || "").trim().toLowerCase();
          const minValue = min.value === "" ? null : Number(min.value);
          const maxValue = max.value === "" ? null : Number(max.value);
          let visibleCount = 0;

          cards.forEach((card) => {
            const name = card.getAttribute("data-course-name") || "";
            const description = card.getAttribute("data-course-description") || "";
            const cardCategory = card.getAttribute("data-category") || "";
            const cardLevel = card.getAttribute("data-level") || "";
            const cardLanguage = card.getAttribute("data-language") || "";
            const price = Number(card.getAttribute("data-price") || 0);

            const matchesQuery =
              !qValue ||
              name.includes(qValue) ||
              description.includes(qValue) ||
              cardCategory.includes(qValue) ||
              cardLevel.includes(qValue) ||
              cardLanguage.includes(qValue);
            const matchesCategory = !categoryValue || cardCategory === categoryValue;
            const matchesLevel = !levelValue || cardLevel === levelValue;
            const matchesLanguage = !languageValue || cardLanguage === languageValue;
            const matchesMin = minValue === null || (!Number.isNaN(minValue) && price >= minValue);
            const matchesMax = maxValue === null || (!Number.isNaN(maxValue) && price <= maxValue);

            const show = matchesQuery && matchesCategory && matchesLevel && matchesLanguage && matchesMin && matchesMax;
            card.style.display = show ? "" : "none";
            if (show) visibleCount += 1;
          });

          emptyState.style.display = visibleCount ? "none" : "block";
          if (!visibleCount && emptyMsg) {
            emptyMsg.textContent = "No courses match your current filters.";
          }
          if (emptyResetBtn) {
            emptyResetBtn.style.display = visibleCount ? "none" : "";
          }
          visibilityText.textContent = "Showing " + visibleCount + " of " + cards.length + " courses";
        };

        form.addEventListener("submit", function (event) {
          event.preventDefault();
          applyFilters();
        });

        [q, category, level, language, min, max].forEach((el) => {
          el.addEventListener("input", applyFilters);
          el.addEventListener("change", applyFilters);
        });

        clearBtn.addEventListener("click", function () {
          q.value = "";
          category.value = "";
          level.value = "";
          language.value = "";
          min.value = "";
          max.value = "";
          applyFilters();
        });

        if (emptyResetBtn) {
          emptyResetBtn.addEventListener("click", function () {
            clearBtn.click();
          });
        }

        applyFilters();
      })();
    </script>
  </body>
</html>

