<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Activity</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="/styles/style.css" />
  </head>
  <body class="admin-dashboard">
    <%- include("partials/navbar") %>
    <main class="admin-main">
      <section class="hero-intro mb-4">
        <div>
          <p class="eyebrow text-uppercase text-muted mb-1">User inspection</p>
          <h1 class="display-6 fw-bold mb-1"><%= user.name %></h1>
          <p class="lead text-muted mb-0"><%= user.email %></p>
        </div>
        <div class="hero-cta">
          <a class="btn btn-outline-secondary btn-sm" href="/dashboard/admin">Back to admin dashboard</a>
        </div>
      </section>

      <% if (status?.status_updated === "1") { %>
        <div class="alert alert-success">Account status updated.</div>
      <% } %>
      <% if (status?.status_updated === "self") { %>
        <div class="alert alert-warning">You cannot suspend your own account.</div>
      <% } %>
      <% if (status?.role_updated === "1") { %>
        <div class="alert alert-success">User role updated.</div>
      <% } %>
      <% if (status?.role_updated === "self") { %>
        <div class="alert alert-warning">You cannot change your own role.</div>
      <% } %>

      <section class="dashboard-panel card shadow-sm mb-4">
        <div class="card-body">
          <div class="d-flex flex-wrap gap-4 align-items-center justify-content-between">
            <div>
              <p class="mb-1"><strong>User ID:</strong> <%= user.id %></p>
              <p class="mb-1 text-capitalize"><strong>Role:</strong> <%= user.role %></p>
              <p class="mb-0"><strong>Status:</strong>
                <span class="status-badge <%= user.account_status === 'suspended' ? 'status-badge-warning' : 'status-badge-success' %>">
                  <%= user.account_status || "active" %>
                </span>
              </p>
            </div>
            <div class="d-flex flex-wrap gap-2">
              <form method="POST" action="/admin/users/<%= user.id %>/role" class="d-flex gap-2">
                <input type="hidden" name="redirect_to" value="detail" />
                <select class="form-select form-select-sm role-select" name="role">
                  <option value="student" <%= user.role === "student" ? "selected" : "" %>>Student</option>
                  <option value="lecturer" <%= user.role === "lecturer" ? "selected" : "" %>>Lecturer</option>
                  <option value="admin" <%= user.role === "admin" ? "selected" : "" %>>Admin</option>
                </select>
                <button class="btn btn-outline-primary" type="submit">Update role</button>
              </form>
              <form method="POST" action="/admin/users/<%= user.id %>/status" class="d-flex gap-2">
                <input type="hidden" name="account_status" value="<%= user.account_status === 'suspended' ? 'active' : 'suspended' %>" />
                <button class="btn <%= user.account_status === 'suspended' ? 'btn-success' : 'btn-danger' %>" type="submit">
                  <%= user.account_status === "suspended" ? "Reactivate account" : "Suspend account" %>
                </button>
              </form>
            </div>
          </div>
        </div>
      </section>

      <div class="row g-4">
        <section class="col-12 col-xl-6">
          <div class="dashboard-panel card shadow-sm h-100">
            <div class="panel-header mb-3">
              <h2 class="h5 mb-0">Subscribed Plan</h2>
            </div>
            <div class="card-body pt-0">
              <% if (!subscription) { %>
                <p class="text-muted mb-0">No active subscription record.</p>
              <% } else { %>
                <p class="mb-1"><strong><%= subscription.plan_name %></strong> (<%= subscription.plan_code %>)</p>
                <p class="mb-1 text-capitalize">Status: <%= subscription.status %></p>
                <p class="mb-0">Monthly: $<%= Number(subscription.monthly_price || 0).toFixed(2) %></p>
              <% } %>
            </div>
          </div>
        </section>

        <section class="col-12 col-xl-6">
          <div class="dashboard-panel card shadow-sm h-100">
            <div class="panel-header mb-3">
              <h2 class="h5 mb-0"><%= String(user.role || "").toLowerCase() === "lecturer" ? "Assigned Courses" : "Enrolled Courses" %></h2>
            </div>
            <div class="card-body pt-0">
              <% if (String(user.role || "").toLowerCase() === "lecturer") { %>
                <% if (!assignedCourses || assignedCourses.length === 0) { %>
                  <p class="text-muted mb-0">No assigned courses.</p>
                <% } else { %>
                  <ul class="mb-0">
                    <% assignedCourses.forEach(function (item) { %>
                      <li><%= item.course_name %> (<%= item.category || "General" %>)</li>
                    <% }) %>
                  </ul>
                <% } %>
              <% } else { %>
                <% if (!enrollments || enrollments.length === 0) { %>
                  <p class="text-muted mb-0">No enrolled courses.</p>
                <% } else { %>
                  <ul class="mb-0">
                    <% enrollments.forEach(function (item) { %>
                      <li><%= item.course_name %> (<%= item.category || "General" %>)</li>
                    <% }) %>
                  </ul>
                <% } %>
              <% } %>
            </div>
          </div>
        </section>
      </div>

      <section class="dashboard-panel card shadow-sm mt-4">
        <div class="panel-header mb-3">
          <h2 class="h5 mb-0">Activity Log</h2>
        </div>
        <div class="table-responsive">
          <table class="table table-borderless align-middle mb-0 admin-table">
            <thead>
              <tr>
                <th>When</th>
                <th>Activity</th>
                <th>Amount</th>
                <th>Actor</th>
                <th>IP</th>
              </tr>
            </thead>
            <tbody>
              <% if (!timeline || timeline.length === 0) { %>
                <tr>
                  <td colspan="5" class="text-center text-muted">No activity logs yet.</td>
                </tr>
              <% } else { %>
                <% timeline.forEach(function (a) { %>
                  <tr>
                    <td class="activity-text"><%= a.created_at ? new Date(a.created_at).toLocaleString() : "" %></td>
                    <td class="activity-text">
                      <% if (a.kind === "transaction") { %>
                        Transaction: <%= String(a.transaction_type || "").replace(/_/g, " ") %> (<%= a.status || "unknown" %>)
                      <% } else if (a.activity_type === "login") { %>
                        Logged in
                      <% } else if (a.activity_type === "logout") { %>
                        Logged out
                      <% } else if (a.activity_type === "account_suspended") { %>
                        Account suspended
                      <% } else if (a.activity_type === "account_reactivated") { %>
                        Account reactivated
                      <% } else if (a.activity_type === "plan_subscribed") { %>
                        Subscribed to plan
                      <% } else if (a.activity_type === "course_enrolled") { %>
                        Enrolled in course
                      <% } else { %>
                        <%= String(a.activity_type || "").replace(/_/g, " ") %>
                      <% } %>
                    </td>
                    <td>
                      <% if (a.kind === "transaction") { %>
                        <span class="txn-amount <%= a.direction === 'topup' ? 'txn-amount-topup' : a.direction === 'spend' ? 'txn-amount-spend' : 'txn-amount-neutral' %>">
                          <%= a.direction === "topup" ? "+" : a.direction === "spend" ? "-" : "" %>$<%= Number(a.amount || 0).toFixed(2) %>
                        </span>
                      <% } else { %>
                        -
                      <% } %>
                    </td>
                    <td class="activity-text"><%= a.actor_user_id || "-" %></td>
                    <td class="activity-text"><%= a.ip_address || "-" %></td>
                  </tr>
                <% }) %>
              <% } %>
            </tbody>
          </table>
        </div>
      </section>
    </main>
  </body>
</html>
